"""
FastORM Â¢ûÂº∫Êü•ËØ¢ÊûÑÂª∫Âô®

ÂÆûÁé∞ÁúüÊ≠£ÁÆÄÊ¥ÅÁöÑÈìæÂºèÊü•ËØ¢API„ÄÇ
"""

from __future__ import annotations

from typing import Any, Dict, List, Optional, Type, TypeVar, Generic

from sqlalchemy import select, and_, asc, desc, func
from sqlalchemy.ext.asyncio import AsyncSession

from fastorm.core.session_manager import execute_with_session

T = TypeVar('T')


class EnhancedQueryBuilder(Generic[T]):
    """Â¢ûÂº∫ÁöÑÊü•ËØ¢ÊûÑÂª∫Âô®
    
    ÂÆûÁé∞ThinkORMÈ£éÊ†ºÁöÑÁÆÄÊ¥ÅÈìæÂºèÊü•ËØ¢„ÄÇ
    
    Á§∫‰æã:
    ```python
    # üéØ ÁÆÄÊ¥ÅÁöÑÈìæÂºèÊü•ËØ¢
    users = await User.where('age', '>', 18)\
                     .where('status', 'active')\
                     .order_by('name')\
                     .limit(10)\
                     .get()
    ```
    """
    
    def __init__(self, model_class: Type[T]):
        self._model_class = model_class
        self._conditions = []
        self._order_clauses = []
        self._limit_value: Optional[int] = None
        self._offset_value: Optional[int] = None
        self._distinct_value: bool = False
    
    def where(
        self, 
        column: str, 
        operator: str = "=", 
        value: Any = None
    ) -> 'EnhancedQueryBuilder[T]':
        """Ê∑ªÂä†WHEREÊù°‰ª∂
        
        Args:
            column: ÂàóÂêç
            operator: Êìç‰ΩúÁ¨¶ ('=', '>', '<', '>=', '<=', '!=', 'like', 'in')
            value: ÂÄº
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æãÔºàÊîØÊåÅÈìæÂºèË∞ÉÁî®Ôºâ
            
        Example:
            User.where('age', '>', 18)
            User.where('name', 'like', '%John%')
            User.where('status', 'in', ['active', 'pending'])
        """
        column_attr = getattr(self._model_class, column)
        
        if operator.lower() == '=':
            condition = column_attr == value
        elif operator.lower() == '>':
            condition = column_attr > value
        elif operator.lower() == '<':
            condition = column_attr < value
        elif operator.lower() == '>=':
            condition = column_attr >= value
        elif operator.lower() == '<=':
            condition = column_attr <= value
        elif operator.lower() in ('!=', '<>'):
            condition = column_attr != value
        elif operator.lower() == 'like':
            condition = column_attr.like(value)
        elif operator.lower() == 'ilike':
            condition = column_attr.ilike(value)
        elif operator.lower() == 'in':
            condition = column_attr.in_(value)
        elif operator.lower() == 'not in':
            condition = ~column_attr.in_(value)
        elif operator.lower() == 'is null':
            condition = column_attr.is_(None)
        elif operator.lower() == 'is not null':
            condition = column_attr.is_not(None)
        else:
            raise ValueError(f"‰∏çÊîØÊåÅÁöÑÊìç‰ΩúÁ¨¶: {operator}")
        
        self._conditions.append(condition)
        return self
    
    def where_in(self, column: str, values: List[Any]) -> 'EnhancedQueryBuilder[T]':
        """WHERE IN Êü•ËØ¢
        
        Args:
            column: ÂàóÂêç
            values: ÂÄºÂàóË°®
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.where_in('status', ['active', 'pending'])
        """
        return self.where(column, 'in', values)
    
    def where_not_in(
        self, 
        column: str, 
        values: List[Any]
    ) -> 'EnhancedQueryBuilder[T]':
        """WHERE NOT IN Êü•ËØ¢
        
        Args:
            column: ÂàóÂêç
            values: ÂÄºÂàóË°®
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.where_not_in('status', ['deleted', 'banned'])
        """
        return self.where(column, 'not in', values)
    
    def where_null(self, column: str) -> 'EnhancedQueryBuilder[T]':
        """WHERE IS NULL Êü•ËØ¢
        
        Args:
            column: ÂàóÂêç
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.where_null('deleted_at')
        """
        return self.where(column, 'is null')
    
    def where_not_null(self, column: str) -> 'EnhancedQueryBuilder[T]':
        """WHERE IS NOT NULL Êü•ËØ¢
        
        Args:
            column: ÂàóÂêç
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.where_not_null('email')
        """
        return self.where(column, 'is not null')
    
    def order_by(
        self, 
        column: str, 
        direction: str = 'asc'
    ) -> 'EnhancedQueryBuilder[T]':
        """Ê∑ªÂä†ÊéíÂ∫è
        
        Args:
            column: ÂàóÂêç
            direction: ÊéíÂ∫èÊñπÂêë ('asc' Êàñ 'desc')
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.order_by('created_at', 'desc')
            User.order_by('name')  # ÈªòËÆ§ÂçáÂ∫è
        """
        column_attr = getattr(self._model_class, column)
        
        if direction.lower() == 'desc':
            order_clause = desc(column_attr)
        else:
            order_clause = asc(column_attr)
        
        self._order_clauses.append(order_clause)
        return self
    
    def limit(self, count: int) -> 'EnhancedQueryBuilder[T]':
        """ÈôêÂà∂ËÆ∞ÂΩïÊï∞Èáè
        
        Args:
            count: ËÆ∞ÂΩïÊï∞Èáè
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.limit(10)
        """
        self._limit_value = count
        return self
    
    def offset(self, count: int) -> 'EnhancedQueryBuilder[T]':
        """Ë∑≥ËøáËÆ∞ÂΩïÊï∞Èáè
        
        Args:
            count: Ë∑≥ËøáÁöÑËÆ∞ÂΩïÊï∞Èáè
            
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.offset(20)
        """
        self._offset_value = count
        return self
    
    def distinct(self) -> 'EnhancedQueryBuilder[T]':
        """ÂéªÈáçÊü•ËØ¢
        
        Returns:
            Êü•ËØ¢ÊûÑÂª∫Âô®ÂÆû‰æã
            
        Example:
            User.distinct()
        """
        self._distinct_value = True
        return self
    
    def _build_query(self):
        """ÊûÑÂª∫SQLAlchemyÊü•ËØ¢"""
        query = select(self._model_class)
        
        # Ê∑ªÂä†Êù°‰ª∂
        if self._conditions:
            query = query.where(and_(*self._conditions))
        
        # Ê∑ªÂä†ÊéíÂ∫è
        if self._order_clauses:
            query = query.order_by(*self._order_clauses)
        
        # Ê∑ªÂä†ÂéªÈáç
        if self._distinct_value:
            query = query.distinct()
        
        # Ê∑ªÂä†ÂÅèÁßªÂíåÈôêÂà∂
        if self._offset_value is not None:
            query = query.offset(self._offset_value)
        
        if self._limit_value is not None:
            query = query.limit(self._limit_value)
        
        return query
    
    # =================================================================
    # ÊâßË°åÊñπÊ≥ï - Êó†ÈúÄsessionÂèÇÊï∞
    # =================================================================
    
    async def get(self) -> List[T]:
        """ÊâßË°åÊü•ËØ¢Âπ∂Ëé∑ÂèñÊâÄÊúâÁªìÊûú
        
        Returns:
            Ê®°ÂûãÂÆû‰æãÂàóË°®
            
        Example:
            users = await User.where('age', '>', 18).get()
        """
        async def _get(session: AsyncSession) -> List[T]:
            query = self._build_query()
            result = await session.execute(query)
            return list(result.scalars().all())
        
        return await execute_with_session(_get)
    
    async def first(self) -> Optional[T]:
        """Ëé∑ÂèñÁ¨¨‰∏ÄÊù°ËÆ∞ÂΩï
        
        Returns:
            Ê®°ÂûãÂÆû‰æãÊàñNone
            
        Example:
            user = await User.where('email', email).first()
        """
        async def _first(session: AsyncSession) -> Optional[T]:
            query = self._build_query().limit(1)
            result = await session.execute(query)
            return result.scalars().first()
        
        return await execute_with_session(_first)
    
    async def count(self) -> int:
        """ÁªüËÆ°ËÆ∞ÂΩïÊï∞Èáè
        
        Returns:
            ËÆ∞ÂΩïÊï∞Èáè
            
        Example:
            count = await User.where('status', 'active').count()
        """
        async def _count(session: AsyncSession) -> int:
            # ÊûÑÂª∫countÊü•ËØ¢
            count_query = select(func.count()).select_from(self._model_class)
            
            # Ê∑ªÂä†Êù°‰ª∂
            if self._conditions:
                count_query = count_query.where(and_(*self._conditions))
            
            result = await session.execute(count_query)
            return result.scalar() or 0
        
        return await execute_with_session(_count)
    
    async def exists(self) -> bool:
        """Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÂåπÈÖçÁöÑËÆ∞ÂΩï
        
        Returns:
            TrueÂ¶ÇÊûúÂ≠òÂú®ËÆ∞ÂΩïÔºåÂê¶ÂàôFalse
            
        Example:
            exists = await User.where('email', email).exists()
        """
        count = await self.count()
        return count > 0
    
    async def delete(self) -> int:
        """Âà†Èô§ÂåπÈÖçÁöÑËÆ∞ÂΩï
        
        Returns:
            Âà†Èô§ÁöÑËÆ∞ÂΩïÊï∞Èáè
            
        Example:
            deleted = await User.where('status', 'inactive').delete()
        """
        async def _delete(session: AsyncSession) -> int:
            from sqlalchemy import delete
            
            delete_query = delete(self._model_class)
            
            # Ê∑ªÂä†Êù°‰ª∂
            if self._conditions:
                delete_query = delete_query.where(and_(*self._conditions))
            
            result = await session.execute(delete_query)
            return result.rowcount or 0
        
        return await execute_with_session(_delete)
    
    # =================================================================
    # ÂàÜÈ°µÊñπÊ≥ï
    # =================================================================
    
    async def paginate(
        self, 
        page: int = 1, 
        per_page: int = 15
    ) -> Dict[str, Any]:
        """ÂàÜÈ°µÊü•ËØ¢
        
        Args:
            page: È°µÁ†ÅÔºà‰ªé1ÂºÄÂßãÔºâ
            per_page: ÊØèÈ°µËÆ∞ÂΩïÊï∞
            
        Returns:
            ÂåÖÂê´ÂàÜÈ°µ‰ø°ÊÅØÁöÑÂ≠óÂÖ∏
            
        Example:
            result = await User.where('status', 'active').paginate(page=2, per_page=10)
        """
        # ËÆ°ÁÆóÂÅèÁßªÈáè
        offset = (page - 1) * per_page
        
        # Ëé∑ÂèñÊÄªÊï∞
        total = await self.count()
        
        # Ëé∑ÂèñÂΩìÈ°µÊï∞ÊçÆ
        items = await self.offset(offset).limit(per_page).get()
        
        # ËÆ°ÁÆóÂàÜÈ°µ‰ø°ÊÅØ
        total_pages = (total + per_page - 1) // per_page
        has_prev = page > 1
        has_next = page < total_pages
        
        return {
            'items': items,
            'total': total,
            'page': page,
            'per_page': per_page,
            'total_pages': total_pages,
            'has_prev': has_prev,
            'has_next': has_next,
            'prev_page': page - 1 if has_prev else None,
            'next_page': page + 1 if has_next else None,
        } 