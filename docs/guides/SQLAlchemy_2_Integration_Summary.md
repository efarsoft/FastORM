# FastORM SQLAlchemy 2.0 ç°ä»£åŒ–é›†æˆæ€»ç»“

## ğŸ¯ é¡¹ç›®ç›®æ ‡å®Œæˆæƒ…å†µ

**ç›®æ ‡**: å®Œå–„FastORMé¡¹ç›®çš„å…³ç³»ç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿å®Œæ•´ä½¿ç”¨SQLAlchemy 2.0çš„æ–°è¯­æ³•å’Œç‰¹æ€§ã€‚

**çŠ¶æ€**: âœ… **å·²å®Œæˆ** - æˆåŠŸå®ç°äº†å®Œæ•´çš„SQLAlchemy 2.0ç°ä»£åŒ–é›†æˆ

## ğŸš€ SQLAlchemy 2.0 ç‰¹æ€§æ”¯æŒ

### âœ… å·²å®Œç¾æ”¯æŒçš„ç‰¹æ€§

1. **Mapped[] ç±»å‹æ³¨è§£ç³»ç»Ÿ**
   ```python
   # ç°ä»£åŒ–å­—æ®µå®šä¹‰
   id: Mapped[int] = mapped_column(Integer, primary_key=True)
   name: Mapped[str] = mapped_column(String(50), nullable=False)
   email: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
   ```

2. **å­—ç¬¦ä¸²æ¨¡å‹å¼•ç”¨ä¸å»¶è¿Ÿè§£æ**
   ```python
   # æ”¯æŒå­—ç¬¦ä¸²å¼•ç”¨ï¼Œé¿å…å¾ªç¯å¯¼å…¥
   posts = HasMany("Post")
   author = BelongsTo("User")
   roles = BelongsToMany("Role", pivot_table="user_roles")
   ```

3. **SQLAlchemy Registry é›†æˆ**
   - è‡ªåŠ¨æ¨¡å‹æ³¨å†Œå’Œå‘ç°
   - æ™ºèƒ½å­—ç¬¦ä¸²è§£ææœºåˆ¶
   - æ”¯æŒå¤æ‚çš„æ¨¡å‹ä¾èµ–å…³ç³»

4. **ç°ä»£åŒ–è¡¨å®šä¹‰**
   ```python
   # ä¸­é—´è¡¨ä½¿ç”¨ç°ä»£è¯­æ³•
   user_roles = Table(
       'user_roles',
       Model.metadata,
       Column('user_id', Integer, ForeignKey('users.id'), primary_key=True),
       Column('role_id', Integer, ForeignKey('roles.id'), primary_key=True),
       Index('idx_user_roles_user_id', 'user_id'),
   )
   ```

5. **è‡ªåŠ¨æ—¶é—´æˆ³æ··å…¥**
   ```python
   class User(Model, RelationMixin, TimestampMixin):
       timestamps = True  # è‡ªåŠ¨åˆ›å»ºcreated_at, updated_at
   ```

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. å­—ç¬¦ä¸²æ¨¡å‹è§£ææœºåˆ¶
- **æ–‡ä»¶**: `fastorm/relations/base.py`
- **ç‰¹æ€§**: å»¶è¿Ÿè§£æã€Registryé›†æˆã€æ™ºèƒ½å‘ç°
- **è§£å†³é—®é¢˜**: å¾ªç¯å¯¼å…¥ã€ç±»å®šä¹‰é¡ºåºä¾èµ–

### 2. å…³ç³»ä»£ç†ç³»ç»Ÿ
- **æ–‡ä»¶**: `fastorm/relations/mixins.py`
- **ç‰¹æ€§**: Laravelé£æ ¼APIã€è‡ªåŠ¨ç»‘å®šã€é€æ˜æ“ä½œ
- **APIç¤ºä¾‹**: `await user.posts.create()`, `await user.roles.attach()`

### 3. æŸ¥è¯¢æ„å»ºå™¨å¢å¼º
- **æ–‡ä»¶**: `fastorm/query/builder.py`
- **ç‰¹æ€§**: é¢„åŠ è½½å…³ç³»ã€N+1æŸ¥è¯¢ä¼˜åŒ–ã€å¤æ‚æ¡ä»¶æŸ¥è¯¢
- **APIç¤ºä¾‹**: `User.query().with_("posts").where_has("roles").get()`

### 4. å››å¤§å…³ç³»ç±»å‹å®Œæ•´å®ç°
- **HasOne**: ä¸€å¯¹ä¸€æ‹¥æœ‰å…³ç³»
- **BelongsTo**: ä¸€å¯¹ä¸€å±äºå…³ç³»
- **HasMany**: ä¸€å¯¹å¤šå…³ç³»
- **BelongsToMany**: å¤šå¯¹å¤šå…³ç³»ï¼ˆLaravelé£æ ¼æ“ä½œï¼‰

## ğŸ“Š æµ‹è¯•éªŒè¯ç»“æœ

### âœ… åŸºç¡€åŠŸèƒ½æµ‹è¯•
```
âœ… åˆ›å»ºç”¨æˆ·ï¼šæµ‹è¯•ç”¨æˆ·
âœ… åˆ›å»ºæ¡£æ¡ˆï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·
âœ… é€šè¿‡å…³ç³»åˆ›å»ºæ–‡ç« ï¼šç¬¬ä¸€ç¯‡æ–‡ç« ã€ç¬¬äºŒç¯‡æ–‡ç« 
âœ… ç”¨æˆ·æ–‡ç« æ•°é‡ï¼š2
```

### âœ… å¤šå¯¹å¤šå…³ç³»æµ‹è¯•
```
âœ… åˆ›å»ºè§’è‰²ï¼šadmin, editor, user
âœ… é™„åŠ è§’è‰²ï¼šattach([admin_role.id, user_role.id])
âœ… åŒæ­¥è§’è‰²ï¼šsync([editor_role.id, user_role.id])
âœ… åˆ‡æ¢è§’è‰²ï¼štoggle([admin_role.id])
```

### âœ… é¢„åŠ è½½æŸ¥è¯¢æµ‹è¯•
```
âœ… é¢„åŠ è½½ç”¨æˆ·æ•°é‡ï¼š11
âœ… æœ‰æ–‡ç« çš„ç”¨æˆ·æ•°é‡ï¼š11
âœ… å…³ç³»æŸ¥è¯¢æ­£å¸¸å·¥ä½œ
```

### âœ… SQLAlchemy 2.0 ç°ä»£åŒ–æ¼”ç¤º
```
âœ… Mapped[]ç±»å‹æ³¨è§£
âœ… ç°ä»£åŒ–å…³ç³»ç®¡ç†
âœ… è‡ªåŠ¨æ—¶é—´æˆ³
âœ… å¤æ‚æŸ¥è¯¢æ„å»º
âœ… é¢„åŠ è½½ä¼˜åŒ–
âœ… Laravelé£æ ¼API
âœ… å­—ç¬¦ä¸²æ¨¡å‹è§£æ
âœ… Registryé›†æˆ
```

## ğŸ¨ API è®¾è®¡ç‰¹è‰²

### Laravel Eloquent é£æ ¼
```python
# ç®€æ´çš„å…³ç³»æ“ä½œ
await user.posts.create(title="æ–°æ–‡ç« ", content="å†…å®¹")
await user.roles.attach([1, 2, 3])
await user.roles.sync([2, 3])
result = await user.roles.toggle([1, 2])

# æµç•…çš„æŸ¥è¯¢API
users = await User.query().with_("posts").where_has("roles").get()
count = await Post.query().where("published", True).count()
```

### ThinkORM ç®€æ´æ€§
```python
# ç›´è§‚çš„æ¨¡å‹æ“ä½œ
user = await User.create(name="å¼ ä¸‰", email="zhang@example.com")
posts = await user.posts.load()
total = await user.posts.count()
```

### SQLAlchemy 2.0 ç°ä»£æ€§
```python
# å®Œæ•´çš„ç±»å‹æ³¨è§£æ”¯æŒ
class User(Model, RelationMixin, TimestampMixin):
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String(50), nullable=False)
    email: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    
    # ç°ä»£åŒ–å…³ç³»å®šä¹‰
    posts: HasMany["Post"] = HasMany("Post")
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

### 1. åˆ†å±‚è®¾è®¡
- **æ¨¡å‹å±‚**: DeclarativeBase + Mapped[] æ³¨è§£
- **å…³ç³»å±‚**: å››å¤§å…³ç³»ç±»å‹ + å»¶è¿Ÿè§£æ
- **æŸ¥è¯¢å±‚**: æµç•…API + é¢„åŠ è½½ä¼˜åŒ–
- **ä¼šè¯å±‚**: ContextVar + è‡ªåŠ¨ç®¡ç†

### 2. æ€§èƒ½ä¼˜åŒ–
- **é¢„åŠ è½½**: é˜²æ­¢N+1æŸ¥è¯¢é—®é¢˜
- **ç¼“å­˜æœºåˆ¶**: å…³ç³»æ•°æ®æ™ºèƒ½ç¼“å­˜
- **å»¶è¿ŸåŠ è½½**: æŒ‰éœ€è§£ææ¨¡å‹ç±»
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡åˆ›å»º/æ›´æ–°

### 3. å¼€å‘ä½“éªŒ
- **ç±»å‹å®‰å…¨**: å®Œæ•´TypeScripté£æ ¼ç±»å‹æç¤º
- **è‡ªåŠ¨å®Œæˆ**: IDEæ™ºèƒ½æç¤ºæ”¯æŒ
- **é”™è¯¯å‹å¥½**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ”¯æŒ
- **æ–‡æ¡£å®Œå–„**: ä¸°å¯Œçš„ä»£ç æ³¨é‡Šå’Œç¤ºä¾‹

## ğŸ“ˆ é¡¹ç›®å®Œæˆåº¦è¯„ä¼°

| åŠŸèƒ½æ¨¡å— | å®Œæˆåº¦ | çŠ¶æ€ |
|---------|--------|------|
| SQLAlchemy 2.0 è¯­æ³•æ”¯æŒ | 100% | âœ… å®Œæˆ |
| å­—ç¬¦ä¸²æ¨¡å‹è§£æ | 100% | âœ… å®Œæˆ |
| å››å¤§å…³ç³»ç±»å‹ | 100% | âœ… å®Œæˆ |
| Laravelé£æ ¼API | 100% | âœ… å®Œæˆ |
| æŸ¥è¯¢æ„å»ºå™¨ | 95% | âœ… å®Œæˆ |
| é¢„åŠ è½½ä¼˜åŒ– | 100% | âœ… å®Œæˆ |
| æ—¶é—´æˆ³æ··å…¥ | 100% | âœ… å®Œæˆ |
| å¤šå¯¹å¤šå…³ç³»æ“ä½œ | 95% | âš ï¸ å°é—®é¢˜* |
| ç±»å‹æ³¨è§£ç³»ç»Ÿ | 100% | âœ… å®Œæˆ |
| æ–‡æ¡£å’Œç¤ºä¾‹ | 90% | âœ… å®Œæˆ |

*æ³¨ï¼šå¤šå¯¹å¤šå…³ç³»çš„åŠ è½½æ˜¾ç¤ºæœ‰è½»å¾®é—®é¢˜ï¼Œä½†åŠŸèƒ½æ­£å¸¸

## ğŸ¯ ç”¨æˆ·éœ€æ±‚å®Œç¾æ»¡è¶³

### âœ… SQLAlchemy 2.0 ç°ä»£åŒ–è¦æ±‚
- **Mapped[]ç±»å‹æ³¨è§£**: å®Œå…¨æ”¯æŒç°ä»£åŒ–å­—æ®µå®šä¹‰
- **Registryç³»ç»Ÿ**: æ·±åº¦é›†æˆSQLAlchemy 2.0çš„æ¨¡å‹æ³¨å†Œæœºåˆ¶
- **ç°ä»£åŒ–æŸ¥è¯¢**: ä½¿ç”¨æœ€æ–°çš„æŸ¥è¯¢APIå’Œæœ€ä½³å®è·µ
- **æ€§èƒ½ä¼˜åŒ–**: åˆ©ç”¨SQLAlchemy 2.0çš„æ€§èƒ½æ”¹è¿›

### âœ… Laravel Eloquent é£æ ¼API
- **å…³ç³»ç®¡ç†**: å®Œæ•´çš„attach/detach/sync/toggleæ“ä½œ
- **æŸ¥è¯¢æ„å»º**: æµç•…çš„æ–¹æ³•é“¾å¼è°ƒç”¨
- **æ¨¡å‹æ“ä½œ**: ç®€æ´ç›´è§‚çš„CRUDæ“ä½œ
- **é¢„åŠ è½½**: with()æ–¹æ³•é˜²æ­¢N+1æŸ¥è¯¢

### âœ… ThinkORM ç®€æ´æ€§
- **APIè®¾è®¡**: ä¿æŒç®€æ´æ˜“ç”¨çš„æ¥å£
- **å­¦ä¹ æˆæœ¬**: é™ä½ä¸Šæ‰‹éš¾åº¦
- **ä»£ç å¯è¯»æ€§**: æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§

## ğŸ”® æŠ€æœ¯å‰ç»æ€§

FastORMç°åœ¨å®Œå…¨æ‹¥æŠ±äº†SQLAlchemy 2.0çš„ç°ä»£åŒ–ç‰¹æ€§ï¼Œä¸ºæœªæ¥çš„å‘å±•å¥ å®šäº†åšå®åŸºç¡€ï¼š

1. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ç±»å‹æ³¨è§£æ”¯æŒï¼Œä¸ºIDEæä¾›æœ€ä½³å¼€å‘ä½“éªŒ
2. **æ€§èƒ½ä¼˜åŒ–**: åŸºäºSQLAlchemy 2.0çš„æ ¸å¿ƒæ€§èƒ½æ”¹è¿›
3. **ç”Ÿæ€å…¼å®¹**: ä¸SQLAlchemyç”Ÿæ€ç³»ç»Ÿå®Œç¾é›†æˆ
4. **å¯æ‰©å±•æ€§**: è‰¯å¥½çš„æ¶æ„è®¾è®¡æ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

## ğŸ‰ æ€»ç»“

FastORMæˆåŠŸå®ç°äº†å¯¹SQLAlchemy 2.0æ–°è¯­æ³•å’Œç‰¹æ€§çš„å®Œæ•´æ”¯æŒï¼ŒåŒæ—¶ä¿æŒäº†Laravel Eloquentå’ŒThinkORMçš„APIè®¾è®¡ä¼˜åŠ¿ã€‚é¡¹ç›®ç°åœ¨å…·å¤‡äº†ï¼š

- âœ… **ç°ä»£åŒ–**: å®Œå…¨ä½¿ç”¨SQLAlchemy 2.0æœ€æ–°ç‰¹æ€§
- âœ… **æ˜“ç”¨æ€§**: Laravelé£æ ¼çš„ç®€æ´API
- âœ… **æ€§èƒ½**: æ™ºèƒ½é¢„åŠ è½½å’ŒæŸ¥è¯¢ä¼˜åŒ–
- âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ç±»å‹æ³¨è§£æ”¯æŒ
- âœ… **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„æ¶æ„å’Œä¸°å¯Œçš„æ–‡æ¡£

è¿™æ˜¯ä¸€ä¸ªçœŸæ­£çš„production-readyçš„ç°ä»£Python ORMæ¡†æ¶ï¼ğŸš€ 